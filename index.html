<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>QR Tool</title>

  <!-- iOS / PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f6f8ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" href="icon.PNG">

  <style>
    :root{
      --bg:#f6f8ff; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --border:#e2e8f0; --shadow:0 14px 35px rgba(2,6,23,.10);
      --blue:#1677ff; --blue2:#0b5ed7; --chip:#eef5ff; --chipBorder:#d9e7ff;
      --dangerBg:#ffecec; --dangerBorder:#ffd2d2; --dangerText:#b42318; --radius:18px;
    }
    *{box-sizing:border-box}

    html, body{
      width:100%;
      overflow-x:hidden;
      overscroll-behavior-x:none;
      -webkit-text-size-adjust:100%;
      touch-action:pan-y;
    }

    body{
      margin:0;
      padding: calc(18px + env(safe-area-inset-top)) 14px calc(40px + env(safe-area-inset-bottom));
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 12% -10%, #e7f0ff 0%, transparent 60%),
        radial-gradient(1200px 600px at 95% 0%, #eaf9ff 0%, transparent 60%),
        var(--bg);
      -webkit-font-smoothing:antialiased;
    }

    .wrap{max-width:760px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .top{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;margin-bottom:10px}
    .brand{display:flex;flex-direction:column;gap:2px}
    .title{font-size:16px;font-weight:900;letter-spacing:.2px;margin:0;line-height:1.2}
    .sub{margin:0;color:var(--muted);font-size:12px;line-height:1.3}
    .pill{align-self:flex-start;padding:7px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chipBorder);color:#0b3d91;font-size:12px;font-weight:800;white-space:nowrap;user-select:none}

    .grid{display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start}
    @media (max-width:740px){.grid{grid-template-columns:1fr}}

    textarea{
      width:100%;min-height:120px;padding:12px 12px 40px;
      font-size:16px;line-height:1.35;
      border:1px solid var(--border);border-radius:16px;outline:none;
      resize:vertical;background:linear-gradient(180deg,#fbfdff 0%, #ffffff 100%);
      overflow-x:hidden;white-space:pre-wrap;word-break:break-word;touch-action:pan-y;
    }
    textarea:focus{border-color:rgba(22,119,255,.55);box-shadow:0 0 0 4px rgba(22,119,255,.12)}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      appearance:none;border:none;border-radius:14px;padding:12px 14px;
      font-size:14px;font-weight:900;cursor:pointer;transition:.15s;
      display:inline-flex;align-items:center;gap:8px;user-select:none;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
    }
    button:active{transform:translateY(1px)}
    .primary{background:var(--blue);color:#fff}
    .primary:hover{background:var(--blue2)}
    .ghost{background:var(--chip);color:#0b3d91;border:1px solid var(--chipBorder)}
    .danger{background:var(--dangerBg);color:var(--dangerText);border:1px solid var(--dangerBorder)}
    .mini{padding:9px 10px;border-radius:12px;font-size:12px}

    .qrbox{
      border:1px dashed #cfe0ff;border-radius:16px;min-height:320px;
      display:flex;align-items:center;justify-content:center;
      background:linear-gradient(180deg,#f7fbff 0%, #ffffff 100%);
      position:relative;
    }
    .qrbox::after{
      content:"";position:absolute;inset:-40px;
      background: radial-gradient(400px 200px at 50% 10%, rgba(22,119,255,.10), transparent 60%);
      pointer-events:none;
    }

    #qrImg{
      display:block;
      width:300px;height:300px;max-width:100%;
      position:relative;z-index:1;
      border-radius:10px;
      image-rendering: pixelated;
      -webkit-touch-callout: default;
      user-select:none;
    }
    #qrText{position:relative;z-index:1;color:var(--muted);font-size:12px;font-weight:800;letter-spacing:.3px;user-select:none}

    .meta{margin-top:10px;display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:12px}
    #msg{min-height:16px}

    /* ===== HISTORY: danh s√°ch cu·ªôn + c√≥ th·ªùi gian ===== */
    .history{margin-top:14px;padding-top:12px;border-top:1px solid var(--border)}
    .hhead{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .htitle{font-size:12px;color:var(--muted);font-weight:900;letter-spacing:.5px;text-transform:uppercase}

    .hscroll{
      border:1px solid var(--border);
      border-radius:16px;
      background:linear-gradient(180deg,#fbfdff 0%, #ffffff 100%);
      overflow:hidden;
    }
    .hlist{
      max-height:260px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    .hitem{
      display:flex;
      gap:10px;
      padding:12px 12px;
      border-top:1px solid var(--border);
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
    }
    .hitem:first-child{border-top:none}
    .hitem:active{background:#f2f7ff}

    .hleft{
      min-width:38px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding-top:2px;
      color:#0b3d91;
      font-weight:1000;
      opacity:.85;
      font-size:12px;
    }
    .hmain{flex:1;min-width:0}
    .htext{
      font-size:13px;
      font-weight:900;
      color:#0b3d91;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .htime{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
      font-weight:800;
    }

    .empty{
      padding:12px;
      color:#94a3b8;
      font-size:12px;
      font-weight:800;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="brand">
          <p class="title">QR Tool</p>
          <p class="sub">Clipboard / nh·∫≠p tay ‚Üí QR + l·ªãch s·ª≠</p>
        </div>
        <div class="pill" id="pill">Ready</div>
      </div>

      <div class="grid">
        <div>
          <textarea id="t" placeholder="D√°n n·ªôi dung..."></textarea>

          <div class="toolbar">
            <button class="primary" id="paste" type="button">üìã D√°n</button>
            <button class="ghost" id="gen" type="button">‚ö° T·∫°o QR</button>
            <button class="danger" id="clr" type="button">üóëÔ∏è Xo√°</button>
          </div>

          <div class="meta">
            <div>ƒê·ªô d√†i: <b id="len">0</b></div>
            <div id="msg"></div>
          </div>
        </div>

        <div>
          <div class="qrbox" id="qr">
            <div id="qrText">QR</div>
          </div>
        </div>
      </div>

      <div class="history">
        <div class="hhead">
          <div class="htitle">L·ªãch s·ª≠</div>
          <button class="danger mini" id="clearHistory" type="button">Xo√°</button>
        </div>

        <div class="hscroll">
          <div class="hlist" id="hlist"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    // PWA
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(() => {});
      });
    }

    // Lock zoom iOS
    (function lockZoomIOS(){
      ["gesturestart","gesturechange","gestureend"].forEach(ev => {
        document.addEventListener(ev, (e) => e.preventDefault(), { passive:false });
      });
      let lastTouchEnd = 0;
      document.addEventListener("touchend", function(e){
        const now = Date.now();
        if (now - lastTouchEnd <= 300) e.preventDefault();
        lastTouchEnd = now;
      }, { passive:false });
      document.addEventListener("dblclick", (e) => e.preventDefault(), { passive:false });
    })();

    const t = document.getElementById('t');
    const qr = document.getElementById('qr');
    const msg = document.getElementById('msg');
    const lenEl = document.getElementById('len');
    const pill = document.getElementById('pill');
    const hlist = document.getElementById('hlist');

    const DISPLAY_SIZE = 300;
    const MARGIN = 2;
    const LONGPRESS_MS = 450;

    // L∆∞u l·ªãch s·ª≠ d·∫°ng object: { value: "...", ts: 1700000000000 }
    const HISTORY_KEY = "qr_tool_history_list_ts_v1";
    const HISTORY_MAX = 50;

    const norm = (s) => (s || "").toString().trim();
    const setMsg = (s="") => msg.textContent = s;
    const setPill = (s="") => pill.textContent = s;

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }

    function fmtTime(ts){
      // hi·ªÉn th·ªã: dd/mm HH:MM
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${dd}/${mm} ${hh}:${mi}`;
    }

    function loadHistory(){
      try{
        const raw = localStorage.getItem(HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(arr)) return [];
        // migrate old string[] (n·∫øu c√≥)
        if (arr.length && typeof arr[0] === "string"){
          return arr.map(v => ({ value: String(v), ts: Date.now() }));
        }
        return arr
          .filter(x => x && typeof x.value === "string" && typeof x.ts === "number")
          .slice(0, HISTORY_MAX);
      }catch{
        return [];
      }
    }

    function saveHistory(arr){
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
    }

    let history = loadHistory();
    let currentDataUrl = "";

    function renderHistory(){
      if (!history.length){
        hlist.innerHTML = `<div class="empty">Tr·ªëng</div>`;
        return;
      }
      hlist.innerHTML = history.map((it, idx) => `
        <div class="hitem" data-idx="${idx}">
          <div class="hleft">${idx+1}</div>
          <div class="hmain">
            <div class="htext">${escapeHtml(it.value)}</div>
            <div class="htime">${fmtTime(it.ts)}</div>
          </div>
        </div>
      `).join("");
    }

    function pushHistory(value){
      const v = norm(value);
      if (!v) return;

      // ƒë∆∞a item tr√πng l√™n ƒë·∫ßu v√† c·∫≠p nh·∫≠t th·ªùi gian
      const now = Date.now();
      const filtered = history.filter(it => it.value !== v);
      history = [{ value: v, ts: now }, ...filtered].slice(0, HISTORY_MAX);

      saveHistory(history);
      renderHistory();
    }

    function showEmptyQR(){
      currentDataUrl = "";
      qr.innerHTML = '<div id="qrText">QR</div>';
    }

    function fallbackDownloadPNG(){
      if (!currentDataUrl) return;
      const a = document.createElement("a");
      a.href = currentDataUrl;
      a.download = "qr.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setMsg("ƒê√£ t·∫£i PNG");
      setTimeout(()=>setMsg(""), 900);
    }

    function attachLongPress(img){
      let timer = null;
      img.addEventListener("touchstart", () => {
        timer = setTimeout(() => fallbackDownloadPNG(), LONGPRESS_MS);
      }, { passive:true });

      ["touchend","touchcancel","touchmove"].forEach(ev => {
        img.addEventListener(ev, () => {
          if (timer) { clearTimeout(timer); timer = null; }
        }, { passive:true });
      });
    }

    async function draw(value, shouldSave=true){
      const v = norm(value);
      lenEl.textContent = String(v.length);

      if(!v){
        showEmptyQR();
        setMsg("");
        setPill("Ready");
        return;
      }

      try{
        const dpr = window.devicePixelRatio || 1;
        const px = Math.floor(DISPLAY_SIZE * dpr);

        const dataUrl = await QRCode.toDataURL(v, { width: px, margin: MARGIN });
        currentDataUrl = dataUrl;

        qr.innerHTML = "";
        const img = document.createElement("img");
        img.id = "qrImg";
        img.src = dataUrl;
        img.alt = "QR";
        img.style.width = DISPLAY_SIZE + "px";
        img.style.height = DISPLAY_SIZE + "px";
        qr.appendChild(img);

        attachLongPress(img);

        setMsg("");
        setPill("OK");

        if (shouldSave) pushHistory(v);
      }catch(e){
        console.error(e);
        showEmptyQR();
        setMsg("L·ªói");
        setPill("Error");
      }
    }

    // auto update khi g√µ (kh√¥ng l∆∞u l·ªãch s·ª≠)
    let typingTimer = null;
    t.addEventListener('input', () => {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => draw(t.value, false), 120);
    });

    document.getElementById('gen').addEventListener('click', () => draw(t.value, true));
    document.getElementById('clr').addEventListener('click', () => { t.value = ""; draw("", false); });

    document.getElementById('paste').addEventListener('click', async () => {
      try{
        setPill("Paste‚Ä¶");
        if(!navigator.clipboard?.readText){
          setMsg("No clipboard");
          setPill("No");
          return;
        }
        const text = await navigator.clipboard.readText();
        t.value = text || "";
        draw(t.value, true);
      }catch(e){
        console.error(e);
        setMsg("Clipboard error");
        setPill("Error");
      }
    });

    // Click item l·ªãch s·ª≠ -> d√πng l·∫°i
    hlist.addEventListener("click", (e) => {
      const item = e.target.closest(".hitem");
      if (!item) return;
      const idx = Number(item.getAttribute("data-idx"));
      const it = history[idx];
      if (!it) return;
      t.value = it.value;
      draw(it.value, false);
    });

    document.getElementById("clearHistory").addEventListener("click", () => {
      history = [];
      saveHistory(history);
      renderHistory();
      setMsg("");
      setPill("Ready");
    });

    // init
    renderHistory();
    draw("", false);
  </script>
</body>
</html>