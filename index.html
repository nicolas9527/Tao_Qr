<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>QR Tool</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f6f8ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" href="icon.PNG">

  <style>
    :root{
      --bg:#f5f7ff;
      --text:#0b1220;
      --muted:#6b7280;
      --line: rgba(15, 23, 42, .08);

      --blue:#2f6bff;
      --blue2:#1d4ed8;

      --danger:#ff3b30; /* iOS red */
      --radius:22px;
      --shadow: 0 18px 45px rgba(2,6,23,.10);
      --shadow2: 0 10px 24px rgba(2,6,23,.08);
    }

    *{box-sizing:border-box}
    html, body{
      width:100%;
      overflow-x:hidden;
      overscroll-behavior-x:none;
      -webkit-text-size-adjust:100%;
      touch-action:pan-y;
      background:var(--bg);
    }

    body{
      margin:0;
      padding: calc(16px + env(safe-area-inset-top)) 14px calc(28px + env(safe-area-inset-bottom));
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      -webkit-font-smoothing:antialiased;

      background:
        radial-gradient(900px 520px at 10% -10%, rgba(47,107,255,.22) 0%, transparent 65%),
        radial-gradient(900px 520px at 92% 0%, rgba(0,208,255,.16) 0%, transparent 70%),
        radial-gradient(900px 520px at 50% 110%, rgba(255, 59, 48, .10) 0%, transparent 60%),
        var(--bg);
    }

    .wrap{max-width:760px;margin:0 auto}

    .app{
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(255,255,255,.55);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .header{
      padding:14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .brand{display:flex; gap:10px; align-items:center; min-width:0;}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(47,107,255,.18), rgba(0,208,255,.14));
      border:1px solid rgba(47,107,255,.18);
      display:flex;align-items:center;justify-content:center;
      box-shadow: var(--shadow2);
      flex:0 0 auto;
    }
    .logo svg{width:22px;height:22px;opacity:.9}
    .titles{min-width:0}
    .title{margin:0;font-size:16px;font-weight:1000;letter-spacing:.2px;line-height:1.15;}
    .sub{margin:2px 0 0;font-size:12px;color:var(--muted);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .status{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background: rgba(255,255,255,.75);
      border:1px solid var(--line);
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      user-select:none;flex:0 0 auto;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#94a3b8;box-shadow: 0 0 0 4px rgba(148,163,184,.18);}
    .status span{font-size:12px;font-weight:1000;color:#0f172a;}

    .content{padding:0 14px 14px}

    .panel{
      background: rgba(255,255,255,.82);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 12px 30px rgba(2,6,23,.06);
      overflow:hidden;
    }
    .panelInner{padding:12px}

    .labelRow{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      margin-bottom:8px;color:var(--muted);font-size:12px;font-weight:800;
    }
    .lenPill{
      padding:6px 10px;border-radius:999px;
      background: rgba(47,107,255,.10);
      border:1px solid rgba(47,107,255,.18);
      color:#1d4ed8;font-weight:1000;font-size:12px;user-select:none;
    }

    textarea{
      width:100%;
      min-height:96px;
      padding:12px 12px 14px;
      font-size:16px;line-height:1.35;
      border-radius:16px;
      border:1px solid rgba(15, 23, 42, .10);
      outline:none;resize:vertical;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.75));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.75);
      overflow-x:hidden;white-space:pre-wrap;word-break:break-word;
      touch-action:pan-y;
    }
    textarea:focus{
      border-color: rgba(47,107,255,.35);
      box-shadow: 0 0 0 4px rgba(47,107,255,.12), inset 0 1px 0 rgba(255,255,255,.75);
    }

    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    button{
      appearance:none;border:none;border-radius:16px;
      padding:12px 12px;font-size:14px;font-weight:1000;
      cursor:pointer;transition:.12s;
      display:flex;align-items:center;justify-content:center;gap:8px;
      user-select:none;touch-action:manipulation;-webkit-tap-highlight-color:transparent;
      box-shadow: 0 10px 22px rgba(2,6,23,.07);
    }
    button:active{transform:translateY(1px)}
    .btnPrimary{color:#fff;background: linear-gradient(135deg, var(--blue), var(--blue2));}
    .btnSoft{color:#0b3d91;background: rgba(47,107,255,.10);border:1px solid rgba(47,107,255,.18);box-shadow:none;}
    .btnDanger{color:#b42318;background: rgba(255, 77, 79, .12);border:1px solid rgba(255, 77, 79, .30);box-shadow:none;}

    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:12px;
      align-items:start;
    }
    @media (max-width:740px){ .grid{grid-template-columns:1fr} }

    .qrWrap{
      background: rgba(255,255,255,.82);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 12px 30px rgba(2,6,23,.06);
      overflow:hidden;
    }
    .qrHead{
      padding:10px 12px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(47,107,255,.08), rgba(255,255,255,0));
    }
    .qrHead .h{
      font-size:12px;font-weight:1000;color:#0f172a;
      letter-spacing:.4px;text-transform:uppercase;
    }
    .hint{font-size:11px;color:var(--muted);font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .qrbox{
      padding:14px;
      display:flex;align-items:center;justify-content:center;
      min-height:320px;position:relative;
    }
    .qrbox::after{
      content:"";position:absolute;inset:-60px;
      background: radial-gradient(520px 260px at 50% 10%, rgba(47,107,255,.16), transparent 60%);
      pointer-events:none;
    }

    #qrImg{
      display:block;width:300px;height:300px;max-width:100%;
      position:relative;z-index:1;border-radius:18px;background:#fff;
      border: 1px solid rgba(15, 23, 42, .08);
      box-shadow: 0 16px 34px rgba(2,6,23,.10);
      image-rendering: pixelated;
      -webkit-touch-callout: default;
      user-select:none;
    }
    #qrText{
      position:relative;z-index:1;color:var(--muted);
      font-size:12px;font-weight:1000;letter-spacing:.5px;text-transform:uppercase;
      user-select:none;padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.75);
      border: 1px solid var(--line);
    }

    /* ===== HISTORY (iOS-like) ===== */
    .history{
      margin-top:12px;
      background: rgba(255,255,255,.82);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 12px 30px rgba(2,6,23,.06);
      overflow:hidden;
    }
    .hTop{
      padding:10px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,208,255,.10), rgba(255,255,255,0));
    }
    .hTop .h{
      font-size:12px;font-weight:1000;color:#0f172a;
      letter-spacing:.4px;text-transform:uppercase;
    }

    .hlist{
      max-height:280px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      background: rgba(255,255,255,.60);
      padding: 8px 8px 10px;
    }

    .row{
      position:relative;
      overflow:hidden;
      border-radius: 16px;
      margin-bottom: 8px;
      background: transparent;
    }
    .row:last-child{margin-bottom:0}

    .rowActions{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding-right: 10px;
      pointer-events:none;
    }
    .row.open .rowActions{pointer-events:auto}

    .delBtn{
      width:46px;height:46px;
      border-radius:999px;
      border:none;
      background: var(--danger);
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 18px rgba(255,59,48,.22);
      padding:0;margin:0;
    }
    .delBtn:active{transform:translateY(1px)}
    .delBtn svg{width:22px;height:22px;fill:#fff}

    .rowMain{
      position:relative;
      display:flex;
      gap:10px;
      padding: 12px 12px;
      align-items:center;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.06);
      border-radius: 16px;

      transform: translateX(0px);
      transition: transform .18s ease;
      will-change: transform;

      touch-action: pan-y;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }

    .row.open .rowMain{
      transform: translateX(-74px);
      background: #eef0f4;
      border-color: rgba(15,23,42,.05);
    }

    /* ‚úÖ Hi·ªÉn th·ªã m·ª•c ƒëang ch·ªçn */
    .row.selected .rowMain{
      border-color: rgba(47,107,255,.38);
      box-shadow: 0 0 0 3px rgba(47,107,255,.10);
      background: rgba(255,255,255,.95);
    }
    .row.open.selected .rowMain{
      /* khi v·ª´a open v·ª´a selected v·∫´n gi·ªØ highlight nh·∫π */
      box-shadow: 0 0 0 3px rgba(47,107,255,.10);
    }

    .avatar{
      width:40px;height:40px;border-radius:999px;
      background: linear-gradient(135deg, rgba(47,107,255,.16), rgba(0,208,255,.14));
      border: 1px solid rgba(47,107,255,.14);
      display:flex;align-items:center;justify-content:center;
      color:#1d4ed8;font-weight:1000;
      flex:0 0 auto;
      font-size:12px;
    }

    .hmain{flex:1;min-width:0}
    .htext{
      font-size:14px;
      font-weight:1000;
      color:#0f172a;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .htime{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }

    .selMark{
      width:26px;height:26px;
      border-radius:999px;
      background: rgba(47,107,255,.12);
      border: 1px solid rgba(47,107,255,.20);
      display:flex;align-items:center;justify-content:center;
      margin-left:6px;
      opacity:0;
      transform: scale(.95);
      transition: .12s ease;
      flex: 0 0 auto;
    }
    .row.selected .selMark{
      opacity:1;
      transform: scale(1);
    }
    .selMark svg{width:16px;height:16px;fill:#1d4ed8}

    .empty{
      padding:12px;
      color:#94a3b8;
      font-size:12px;
      font-weight:1000;
    }

    .foot{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      margin-top:10px;color:var(--muted);font-size:12px;font-weight:800;
      padding: 0 2px;min-height:18px;
    }
    #msg{min-height:18px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app">
      <div class="header">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M4 4h6v6H4V4Zm10 0h6v6h-6V4ZM4 14h6v6H4v-6Zm10 2h2v2h-2v-2Zm-2-2h2v2h-2v-2Zm4 4h2v2h-2v-2Zm2-4h2v2h-2v-2Zm-4-2h6v6h-6v-6Z" fill="rgba(29,78,216,.95)"/>
              <path d="M6 6h2v2H6V6Zm10 0h2v2h-2V6ZM6 16h2v2H6v-2Z" fill="rgba(0,208,255,.9)"/>
            </svg>
          </div>
          <div class="titles">
            <p class="title">QR Tool</p>
            <p class="sub">Clipboard / nh·∫≠p tay ‚Üí QR + l·ªãch s·ª≠</p>
          </div>
        </div>

        <div class="status" id="status">
          <span class="dot" id="dot"></span>
          <span id="pill">Ready</span>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <!-- LEFT -->
          <div class="panel">
            <div class="panelInner">
              <div class="labelRow">
                <div>Nh·∫≠p n·ªôi dung</div>
                <div class="lenPill">ƒê·ªô d√†i: <span id="len">0</span></div>
              </div>

              <textarea id="t" placeholder="D√°n n·ªôi dung..."></textarea>

              <div class="actions">
                <button class="btnPrimary" id="paste" type="button">üìã D√°n</button>
                <button class="btnSoft" id="gen" type="button">‚ö° T·∫°o QR</button>
                <button class="btnDanger" id="clr" type="button">üóëÔ∏è Xo√°</button>
              </div>

              <div class="foot">
                <div id="msg"></div>
                <div class="hint">Nh·∫•n gi·ªØ QR ƒë·ªÉ l∆∞u</div>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div>
            <div class="qrWrap">
              <div class="qrHead">
                <div class="h">QR</div>
                <div class="hint">T·ª± n√©t theo m√†n h√¨nh</div>
              </div>
              <div class="qrbox" id="qr">
                <div id="qrText">QR</div>
              </div>
            </div>

            <div class="history" id="historyBox">
              <div class="hTop">
                <div class="h">L·ªãch s·ª≠</div>
                <button class="btnDanger" id="clearHistory" type="button"
                        style="padding:9px 12px;border-radius:14px;font-size:12px;font-weight:1000;">
                  Xo√° t·∫•t c·∫£
                </button>
              </div>
              <div class="hlist" id="hlist"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    // PWA
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(() => {});
      });
    }

    // Lock zoom iOS
    (function lockZoomIOS(){
      ["gesturestart","gesturechange","gestureend"].forEach(ev => {
        document.addEventListener(ev, (e) => e.preventDefault(), { passive:false });
      });
      let lastTouchEnd = 0;
      document.addEventListener("touchend", function(e){
        const now = Date.now();
        if (now - lastTouchEnd <= 300) e.preventDefault();
        lastTouchEnd = now;
      }, { passive:false });
      document.addEventListener("dblclick", (e) => e.preventDefault(), { passive:false });
    })();

    const t = document.getElementById('t');
    const qr = document.getElementById('qr');
    const msg = document.getElementById('msg');
    const lenEl = document.getElementById('len');

    const pill = document.getElementById('pill');
    const dot = document.getElementById('dot');

    const hlist = document.getElementById('hlist');

    const DISPLAY_SIZE = 300;
    const MARGIN = 2;
    const LONGPRESS_MS = 450;

    const HISTORY_KEY = "qr_tool_history_swipe_ioslike_v2_selected";
    const HISTORY_MAX = 80;

    const OPEN_REVEAL_PX = 52;  // ng∆∞·ª°ng ƒë·ªÉ m·ªü
    const REVEAL_X = 74;        // px reveal

    const norm = (s) => (s || "").toString().trim();
    const setMsg = (s="") => msg.textContent = s;

    function setStatus(mode){
      if (mode === "ready"){
        pill.textContent = "Ready";
        dot.style.background = "#94a3b8";
        dot.style.boxShadow = "0 0 0 4px rgba(148,163,184,.18)";
        return;
      }
      if (mode === "working"){
        pill.textContent = "‚Ä¶";
        dot.style.background = "#f59e0b";
        dot.style.boxShadow = "0 0 0 4px rgba(245,158,11,.18)";
        return;
      }
      if (mode === "error"){
        pill.textContent = "Error";
        dot.style.background = "#ef4444";
        dot.style.boxShadow = "0 0 0 4px rgba(239,68,68,.18)";
        return;
      }
      pill.textContent = "OK";
      dot.style.background = "#10b981";
      dot.style.boxShadow = "0 0 0 4px rgba(16,185,129,.18)";
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }

    function fmtTime(ts){
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${dd}/${mm} ${hh}:${mi}`;
    }

    function loadHistory(){
      try{
        const raw = localStorage.getItem(HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(arr)) return [];
        if (arr.length && typeof arr[0] === "string"){
          return arr.map(v => ({ value: String(v), ts: Date.now() }));
        }
        return arr
          .filter(x => x && typeof x.value === "string" && typeof x.ts === "number")
          .slice(0, HISTORY_MAX);
      }catch{
        return [];
      }
    }
    function saveHistory(arr){
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
    }

    let history = loadHistory();
    let currentDataUrl = "";
    let openRowEl = null;

    // ‚úÖ l∆∞u ‚Äúƒëang ch·ªçn‚Äù theo VALUE (ƒë·ªÉ reorder v·∫´n ƒë√∫ng)
    let selectedValue = null;

    function closeOpenRow(){
      if (openRowEl){
        openRowEl.classList.remove("open");
        openRowEl = null;
      }
    }

    function renderHistory(){
      if (!history.length){
        hlist.innerHTML = `<div class="empty">Tr·ªëng</div>`;
        return;
      }

      hlist.innerHTML = history.map((it, idx) => {
        const isSel = selectedValue && it.value === selectedValue;
        return `
          <div class="row ${isSel ? "selected" : ""}" data-idx="${idx}">
            <div class="rowActions">
              <button class="delBtn" type="button" data-action="delete" data-idx="${idx}" aria-label="Xo√°">
                <svg viewBox="0 0 24 24">
                  <path d="M9 3h6l1 2h4v2H4V5h4l1-2Zm1 7h2v9h-2v-9Zm4 0h2v9h-2v-9ZM7 10h2v9H7v-9Z"/>
                </svg>
              </button>
            </div>

            <div class="rowMain" data-action="open" data-idx="${idx}">
              <div class="avatar">${String(idx+1)}</div>
              <div class="hmain">
                <div class="htext">${escapeHtml(it.value)}</div>
                <div class="htime">${fmtTime(it.ts)}</div>
              </div>

              <div class="selMark" aria-hidden="true">
                <svg viewBox="0 0 24 24">
                  <path d="M9.2 16.6 4.9 12.3l1.4-1.4 2.9 2.9 8-8 1.4 1.4-9.4 9.4Z"/>
                </svg>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    function pushHistory(value){
      const v = norm(value);
      if (!v) return;
      const now = Date.now();

      // ‚úÖ m·ª•c m·ªõi ƒë∆∞·ª£c ch·ªçn lu√¥n
      selectedValue = v;

      const filtered = history.filter(it => it.value !== v);
      history = [{ value: v, ts: now }, ...filtered].slice(0, HISTORY_MAX);
      saveHistory(history);
      renderHistory();
    }

    function deleteOne(idx){
      if (Number.isNaN(idx) || idx < 0 || idx >= history.length) return;

      // n·∫øu xo√° ƒë√∫ng m·ª•c ƒëang ch·ªçn th√¨ b·ªè ch·ªçn
      if (selectedValue && history[idx].value === selectedValue) selectedValue = null;

      history.splice(idx, 1);
      saveHistory(history);
      renderHistory();
      closeOpenRow();
      setMsg("ƒê√£ xo√° 1 m·ª•c");
      setTimeout(()=>setMsg(""), 700);
    }

    function showEmptyQR(){
      currentDataUrl = "";
      qr.innerHTML = `<div id="qrText">QR</div>`;
    }

    function fallbackDownloadPNG(){
      if (!currentDataUrl) return;
      const a = document.createElement("a");
      a.href = currentDataUrl;
      a.download = "qr.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setMsg("ƒê√£ t·∫£i PNG");
      setTimeout(()=>setMsg(""), 900);
    }

    function attachLongPress(img){
      let timer = null;
      img.addEventListener("touchstart", () => {
        timer = setTimeout(() => fallbackDownloadPNG(), LONGPRESS_MS);
      }, { passive:true });

      ["touchend","touchcancel","touchmove"].forEach(ev => {
        img.addEventListener(ev, () => {
          if (timer) { clearTimeout(timer); timer = null; }
        }, { passive:true });
      });
    }

    async function draw(value, shouldSave=true){
      const v = norm(value);
      lenEl.textContent = String(v.length);

      if(!v){
        showEmptyQR();
        setMsg("");
        setStatus("ready");
        return;
      }

      try{
        setStatus("working");
        const dpr = window.devicePixelRatio || 1;
        const px = Math.floor(DISPLAY_SIZE * dpr);

        const dataUrl = await QRCode.toDataURL(v, { width: px, margin: MARGIN });
        currentDataUrl = dataUrl;

        qr.innerHTML = "";
        const img = document.createElement("img");
        img.id = "qrImg";
        img.src = dataUrl;
        img.alt = "QR";
        img.style.width = DISPLAY_SIZE + "px";
        img.style.height = DISPLAY_SIZE + "px";
        qr.appendChild(img);
        attachLongPress(img);

        setMsg("");
        setStatus("ok");

        if (shouldSave) pushHistory(v);
        else {
          // n·∫øu ƒëang hi·ªÉn th·ªã t·ª´ l·ªãch s·ª≠ th√¨ selectedValue ƒë√£ set khi b·∫•m item
          // kh√¥ng l√†m g√¨
        }
      }catch(e){
        console.error(e);
        showEmptyQR();
        setMsg("L·ªói");
        setStatus("error");
      }
    }

    // ===== Swipe: vu·ªët tr√°i m·ªõi l·ªô n√∫t xo√° =====
    function bindSwipe(){
      let startX=0, startY=0;
      let dragging=false;
      let row=null;

      function getX(el){
        const main = el.querySelector(".rowMain");
        const m = /translateX\(([-0-9.]+)px\)/.exec(main.style.transform || "");
        return m ? parseFloat(m[1]) : (el.classList.contains("open") ? -REVEAL_X : 0);
      }

      function setX(el, x, noAnim=false){
        const main = el.querySelector(".rowMain");
        main.style.transition = noAnim ? "none" : "";
        main.style.transform = `translateX(${x}px)`;
      }

      function resetInline(el){
        const main = el.querySelector(".rowMain");
        main.style.transition = "";
        main.style.transform = "";
      }

      function onStart(e){
        const main = e.target.closest(".rowMain");
        if (!main) return;

        row = main.closest(".row");
        if (!row) return;

        if (openRowEl && openRowEl !== row) closeOpenRow();

        const touch = e.touches[0];
        startX = touch.clientX;
        startY = touch.clientY;
        dragging = false;

        if (row.classList.contains("open")){
          setX(row, -REVEAL_X, true);
        } else {
          setX(row, 0, true);
        }
      }

      function onMove(e){
        if (!row) return;
        const touch = e.touches[0];
        const dx = touch.clientX - startX;
        const dy = touch.clientY - startY;

        if (!dragging){
          if (Math.abs(dx) > 10 && Math.abs(dx) > Math.abs(dy) * 1.2){
            dragging = true;
            e.preventDefault();
          } else {
            return;
          }
        }

        e.preventDefault();

        const opened = row.classList.contains("open");
        const base = opened ? -REVEAL_X : 0;
        let x = base + dx;

        if (x > 0) x = 0;
        if (x < -REVEAL_X) x = -REVEAL_X;

        setX(row, x, true);
      }

      function onEnd(){
        if (!row) return;

        const x = getX(row);
        resetInline(row);

        if (dragging){
          if (x <= -OPEN_REVEAL_PX){
            row.classList.add("open");
            openRowEl = row;
          } else {
            row.classList.remove("open");
            if (openRowEl === row) openRowEl = null;
          }
        }

        dragging = false;
        row = null;
      }

      hlist.addEventListener("touchstart", onStart, { passive:true });
      hlist.addEventListener("touchmove", onMove, { passive:false });
      hlist.addEventListener("touchend", onEnd, { passive:true });
      hlist.addEventListener("touchcancel", onEnd, { passive:true });
    }

    // Click: delete / open
    hlist.addEventListener("click", (e) => {
      const del = e.target.closest('[data-action="delete"]');
      if (del){
        e.preventDefault(); e.stopPropagation();
        deleteOne(Number(del.getAttribute("data-idx")));
        return;
      }

      const main = e.target.closest('[data-action="open"]');
      if (!main) return;

      const row = main.closest(".row");

      // n·∫øu ƒëang open th√¨ click ƒë·ªÉ ƒë√≥ng
      if (row && row.classList.contains("open")){
        closeOpenRow();
        return;
      }

      const idx = Number(main.getAttribute("data-idx"));
      const it = history[idx];
      if (!it) return;

      // ‚úÖ set ƒëang ch·ªçn + highlight
      selectedValue = it.value;
      renderHistory();

      t.value = it.value;
      draw(it.value, false);
    });

    // Tap ra ngo√†i history ƒë·ªÉ ƒë√≥ng row ƒëang m·ªü
    document.addEventListener("click", (e) => {
      if (!openRowEl) return;
      if (!e.target.closest("#historyBox")) closeOpenRow();
    });

    // Buttons
    document.getElementById('gen').addEventListener('click', () => {
      closeOpenRow();
      draw(t.value, true);
    });

    document.getElementById('clr').addEventListener('click', () => {
      closeOpenRow();
      t.value = "";
      selectedValue = null;     // ‚úÖ xo√° input th√¨ b·ªè ch·ªçn lu√¥n
      renderHistory();
      draw("", false);
      setMsg("");
    });

    document.getElementById('paste').addEventListener('click', async () => {
      try{
        closeOpenRow();
        setStatus("working");
        if(!navigator.clipboard?.readText){
          setMsg("No clipboard");
          setStatus("error");
          return;
        }
        const text = await navigator.clipboard.readText();
        t.value = text || "";
        draw(t.value, true);
      }catch(e){
        console.error(e);
        setMsg("Clipboard error");
        setStatus("error");
      }
    });

    // ‚úÖ Xo√° t·∫•t c·∫£: th√™m x√°c nh·∫≠n ƒë·ªÉ tr√°nh b·∫•m nh·∫ßm
    document.getElementById("clearHistory").addEventListener("click", () => {
      closeOpenRow();

      if (!history.length){
        setMsg("L·ªãch s·ª≠ tr·ªëng");
        setTimeout(()=>setMsg(""), 700);
        return;
      }

      const ok = confirm("Xo√° to√†n b·ªô l·ªãch s·ª≠?\nKh√¥ng th·ªÉ ho√†n t√°c.");
      if (!ok) return;

      history = [];
      selectedValue = null;  // ‚úÖ b·ªè ch·ªçn
      saveHistory(history);
      renderHistory();

      setMsg("ƒê√£ xo√° t·∫•t c·∫£");
      setTimeout(()=>setMsg(""), 700);
      setStatus("ready");
    });

    // auto update khi g√µ (kh√¥ng l∆∞u l·ªãch s·ª≠)
    let typingTimer = null;
    t.addEventListener('input', () => {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => draw(t.value, false), 120);
    });

    // init
    renderHistory();
    bindSwipe();
    draw("", false);
    setStatus("ready");
  </script>
</body>
</html>