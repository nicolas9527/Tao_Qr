<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clipboard ‚Üí QR + Danh s√°ch + CSV</title>
  <style>
    :root{
      --blue:#1677ff; --blue2:#0b5ed7; --bg:#f5f8ff; --card:#ffffff;
      --text:#0f172a; --muted:#64748b; --border:#e2e8f0; --shadow:0 10px 24px rgba(2, 6, 23, .10);
      --radius:16px; --good:#0f766e; --bad:#b42318;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, #e7f0ff 0%, transparent 60%),
        radial-gradient(1200px 600px at 90% 0%, #eaf9ff 0%, transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 44px}
    .header{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;margin-bottom:12px}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .sub{margin:4px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .pill{
      padding:6px 10px;border-radius:999px;
      background:#eef5ff;color:#0b3d91;border:1px solid #d9e7ff;
      font-size:12px;white-space:nowrap;align-self:flex-start
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 7px}
    input, textarea{
      width:100%;
      padding:11px 12px;
      font-size:15px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      background:#fbfdff;
    }
    textarea{min-height:110px;resize:vertical;line-height:1.35}
    input:focus, textarea:focus{
      border-color: rgba(22,119,255,.55);
      box-shadow: 0 0 0 4px rgba(22,119,255,.12);
    }
    .row{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button{
      appearance:none;border:none;
      padding:11px 14px;border-radius:12px;
      font-weight:700;font-size:14px;cursor:pointer;
      transition:.15s;
      display:inline-flex;align-items:center;gap:8px;
    }
    button:active{transform:translateY(1px)}
    .btn-primary{background:var(--blue);color:#fff}
    .btn-primary:hover{background:var(--blue2)}
    .btn-ghost{
      background:#eef5ff;color:#0b3d91;border:1px solid #d9e7ff;
      font-weight:700;
    }
    .btn-ghost:hover{filter:brightness(.98)}
    .btn-danger{
      background:#ffecec;color:#b42318;border:1px solid #ffd2d2;
      font-weight:800;
    }
    .btn-danger:hover{filter:brightness(.98)}
    .btn-mini{
      padding:8px 10px;border-radius:10px;font-size:12px;font-weight:800;
    }
    .qrbox{
      display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center;
      padding:14px;border-radius:14px;border:1px dashed #cfe0ff;
      background:linear-gradient(180deg,#f7fbff 0%, #ffffff 100%);
      min-height:260px;
    }
    .hint{font-size:12px;color:var(--muted);text-align:center;margin:0}
    .status{margin-top:10px;font-size:13px;min-height:18px;color:var(--muted)}
    .status.ok{color:var(--good)}
    .status.err{color:var(--bad)}
    .meta{
      display:flex;gap:10px;justify-content:space-between;align-items:center;
      margin-top:10px;padding-top:10px;border-top:1px solid var(--border);
      color:var(--muted);font-size:12px;flex-wrap:wrap
    }

    .listHead{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      margin:16px 0 10px;
    }
    .listTitle{margin:0;font-size:16px}
    .tools{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-end}
    .searchRow{display:flex;gap:10px;flex-wrap:wrap}
    .searchRow input{min-width:min(520px,100%);flex:1}
    .small{font-size:12px;color:var(--muted)}
    table{
      width:100%;border-collapse:separate;border-spacing:0;
      border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fff;
    }
    thead th{
      background:#f3f7ff;color:#244a86;
      font-size:12px;text-transform:uppercase;letter-spacing:.6px;
      padding:10px 10px;border-bottom:1px solid var(--border);text-align:left;
    }
    tbody td{
      padding:10px;border-bottom:1px solid var(--border);vertical-align:middle;
      font-size:14px;
    }
    tbody tr:hover{background:#fbfdff}
    tbody tr:last-child td{border-bottom:none}
    .td-actions{white-space:nowrap}
    .tag{
      font-size:12px;padding:4px 8px;border-radius:999px;
      background:#eef5ff;border:1px solid #d9e7ff;color:#0b3d91;display:inline-block
    }
    .sku{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:13px;color:#0b3d91
    }
    .clickable{cursor:pointer}
    .muted{color:var(--muted);font-size:12px}
    .fileInput{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:12px;
      background:#eef5ff;border:1px solid #d9e7ff;color:#0b3d91;
      font-weight:800;font-size:13px;cursor:pointer;
    }
    .fileInput input{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Tool d√°n Clipboard ‚Üí t·∫°o QR + l∆∞u danh s√°ch + nh·∫≠p/xu·∫•t CSV</h1>
        <p class="sub">
          CSV theo chu·∫©n b·∫°n d√πng: <b>M√£ s·∫£n ph·∫©m,T√™n s·∫£n ph·∫©m</b> (2 c·ªôt).
          B·∫•m item trong danh s√°ch ƒë·ªÉ n·∫°p l·∫°i v√† hi·ªÉn th·ªã QR.
        </p>
      </div>
      <div class="pill" id="env">Clipboard: ƒëang ki·ªÉm tra‚Ä¶</div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="name">T√™n</label>
          <input id="name" placeholder="VD: B√°nh A, Ch√°o B..." />

          <label for="sku">M√£ s·∫£n ph·∫©m (SKU)</label>
          <input id="sku" placeholder="VD: 8934..." inputmode="numeric" />

          <label for="payload">N·ªôi dung t·∫°o QR (ƒë·ªÉ tr·ªëng = QR l·∫•y theo SKU)</label>
          <textarea id="payload" placeholder="D√°n link/text... ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ QR = SKU"></textarea>

          <div class="row">
            <button class="btn-primary" id="pasteBtn" type="button">üìã D√°n t·ª´ Clipboard</button>
            <button class="btn-ghost" id="makeBtn" type="button">‚ö° T·∫°o/Refresh QR</button>
            <button class="btn-ghost" id="saveBtn" type="button">üíæ L∆∞u v√†o danh s√°ch</button>
            <button class="btn-ghost" id="downloadBtn" type="button">‚¨áÔ∏è T·∫£i QR (PNG)</button>
            <button class="btn-danger" id="clearBtn" type="button">üóëÔ∏è Xo√° form</button>
          </div>

          <div class="status" id="status"></div>
          <div class="meta">
            <div>ƒê·ªô d√†i QR: <b id="len">0</b> k√Ω t·ª±</div>
            <div>T·ªïng ƒë√£ l∆∞u: <b id="count">0</b></div>
            <div class="muted">L∆∞u trong m√°y (localStorage)</div>
          </div>
        </div>

        <div>
          <label>M√£ QR</label>
          <div class="qrbox" id="qrbox">
            <p class="hint">QR s·∫Ω hi·ªán ·ªü ƒë√¢y</p>
          </div>
          <p class="hint" style="margin-top:10px">QR t·∫°o ngay tr√™n m√°y (kh√¥ng g·ª≠i d·ªØ li·ªáu l√™n server).</p>
        </div>
      </div>

      <div class="listHead">
        <h2 class="listTitle">Danh s√°ch ƒë√£ l∆∞u</h2>
        <div class="tools">
          <label class="fileInput" title="Nh·∫≠p CSV (M√£ s·∫£n ph·∫©m,T√™n s·∫£n ph·∫©m)">
            ‚¨ÜÔ∏è Nh·∫≠p CSV
            <input id="csvFile" type="file" accept=".csv,text/csv" />
          </label>
          <button class="btn-ghost" id="exportBtn" type="button">‚¨áÔ∏è Xu·∫•t CSV</button>
          <button class="btn-danger" id="clearListBtn" type="button">üßπ Xo√° to√†n b·ªô</button>
        </div>
      </div>

      <div class="searchRow">
        <input id="search" placeholder="T√¨m theo T√™n ho·∫∑c M√£ s·∫£n ph·∫©m..." />
        <button class="btn-ghost" id="copyAllSkusBtn" type="button">üìé Copy t·∫•t c·∫£ m√£</button>
      </div>
      <div class="small" style="margin:8px 0 10px">
        Tip: b·∫•m v√†o <b>T√™n</b> ho·∫∑c n√∫t <b>Hi·ªÉn th·ªã</b> ƒë·ªÉ n·∫°p l·∫°i item v√† hi·ªán QR. N√∫t <b>Copy m√£</b> ƒë·ªÉ copy nhanh.
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:36%">T√™n</th>
            <th style="width:24%">M√£ s·∫£n ph·∫©m</th>
            <th style="width:26%">QR payload</th>
            <th style="width:14%">Th·ªùi gian</th>
            <th style="width:10%">Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    const STORAGE_KEY = "qr_tool_items_v2_csv_vn_2cols";

    const envEl = document.getElementById("env");
    const statusEl = document.getElementById("status");
    const qrbox = document.getElementById("qrbox");

    const nameEl = document.getElementById("name");
    const skuEl = document.getElementById("sku");
    const payloadEl = document.getElementById("payload");

    const lenEl = document.getElementById("len");
    const countEl = document.getElementById("count");

    const pasteBtn = document.getElementById("pasteBtn");
    const makeBtn = document.getElementById("makeBtn");
    const saveBtn = document.getElementById("saveBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const clearBtn = document.getElementById("clearBtn");

    const searchEl = document.getElementById("search");
    const tbody = document.getElementById("tbody");

    const csvFileEl = document.getElementById("csvFile");
    const exportBtn = document.getElementById("exportBtn");
    const clearListBtn = document.getElementById("clearListBtn");
    const copyAllSkusBtn = document.getElementById("copyAllSkusBtn");

    let items = loadItems(); // {id,name,sku,payload,createdAt}
    let selectedId = null;

    function nowISO(){ return new Date().toISOString(); }
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const day = String(d.getDate()).padStart(2,"0");
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        return `${day}/${m}/${y} ${hh}:${mm}`;
      }catch{ return ""; }
    }

    function setStatus(msg, type=""){
      statusEl.textContent = msg || "";
      statusEl.className = "status" + (type ? " " + type : "");
    }
    function normalize(s){ return (s || "").toString().trim(); }

    function genId(){
      return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function loadItems(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveItems(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      countEl.textContent = String(items.length);
    }

    function getQrValue(){
      const p = normalize(payloadEl.value);
      const sku = normalize(skuEl.value);
      return normalize(p || sku || "");
    }
    function updateLen(){ lenEl.textContent = getQrValue().length.toString(); }
    function clearQRBox(){ qrbox.innerHTML = '<p class="hint">QR s·∫Ω hi·ªán ·ªü ƒë√¢y</p>'; }

    async function renderQR(){
      const value = getQrValue();
      updateLen();
      if (!value){
        clearQRBox();
        setStatus("Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ t·∫°o QR (nh·∫≠p M√£ s·∫£n ph·∫©m ho·∫∑c payload).", "err");
        return;
      }
      qrbox.innerHTML = "";
      try{
        const canvas = document.createElement("canvas");
        await QRCode.toCanvas(canvas, value, { width: 260, margin: 1 });
        qrbox.appendChild(canvas);
        setStatus("ƒê√£ t·∫°o QR.", "ok");
      }catch(e){
        console.error(e);
        clearQRBox();
        setStatus("L·ªói t·∫°o QR. N·ªôi dung c√≥ th·ªÉ qu√° d√†i ho·∫∑c k√Ω t·ª± l·∫°.", "err");
      }
    }

    function downloadPNG(){
      const canvas = qrbox.querySelector("canvas");
      if (!canvas){ setStatus("Ch∆∞a c√≥ QR ƒë·ªÉ t·∫£i.", "err"); return; }
      const sku = normalize(skuEl.value) || "qr";
      const link = document.createElement("a");
      link.download = `${sku}.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
      setStatus("ƒê√£ xu·∫•t QR (PNG).", "ok");
    }

    async function copyToClipboard(text){
      const value = String(text ?? "");
      if (!value) return false;
      try{
        if (navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(value);
          return true;
        }
        const ta = document.createElement("textarea");
        ta.value = value;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        return true;
      }catch{ return false; }
    }

    async function pasteFromClipboard(){
      setStatus("");
      try{
        if (!navigator.clipboard?.readText){
          setStatus("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªçc clipboard. H√£y d√°n th·ªß c√¥ng.", "err");
          return;
        }
        const text = await navigator.clipboard.readText();
        if (!text){ setStatus("Clipboard ƒëang tr·ªëng.", "err"); return; }
        payloadEl.value = text;
        await renderQR();
      }catch(e){
        console.error(e);
        setStatus("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c clipboard (c√≥ th·ªÉ b·ªã ch·∫∑n quy·ªÅn). H√£y d√°n th·ªß c√¥ng r·ªìi b·∫•m ‚ÄòT·∫°o/Refresh QR‚Äô.", "err");
      }finally{
        updateLen();
      }
    }

    function filteredItems(){
      const q = normalize(searchEl.value).toLowerCase();
      const arr = [...items].sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));
      if (!q) return arr;
      return arr.filter(it=>{
        const name = normalize(it.name).toLowerCase();
        const sku = normalize(it.sku).toLowerCase();
        return name.includes(q) || sku.includes(q);
      });
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }
    function escapeAttr(s){ return String(s ?? "").replace(/"/g, "&quot;"); }

    function renderTable(){
      const arr = filteredItems();
      countEl.textContent = String(items.length);

      if (arr.length === 0){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Kh√¥ng c√≥ k·∫øt qu·∫£.</td></tr>`;
        return;
      }

      tbody.innerHTML = arr.map(it=>{
        const payload = normalize(it.payload || it.sku); // n·∫øu payload tr·ªëng -> QR = sku
        const payloadShort = payload.length > 28 ? payload.slice(0, 28) + "‚Ä¶" : payload;
        const isSel = it.id === selectedId;
        return `
          <tr data-id="${it.id}" ${isSel ? 'style="background:#f7fbff"' : ""}>
            <td class="clickable" data-action="show" title="B·∫•m ƒë·ªÉ hi·ªÉn th·ªã QR">
              ${escapeHtml(it.name || "(kh√¥ng t√™n)")}
              ${isSel ? '<span class="tag" style="margin-left:6px">ƒëang ch·ªçn</span>' : ""}
            </td>
            <td class="sku">${escapeHtml(it.sku || "")}</td>
            <td title="${escapeAttr(payload)}">${escapeHtml(payloadShort)}</td>
            <td class="muted">${escapeHtml(fmtDate(it.createdAt || ""))}</td>
            <td class="td-actions">
              <button class="btn-mini btn-ghost" data-action="show" type="button">üëÅÔ∏è Hi·ªÉn th·ªã</button>
              <button class="btn-mini btn-ghost" data-action="copySku" type="button">üìé Copy m√£</button>
              <button class="btn-mini btn-danger" data-action="del" type="button">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    function selectItemById(id){
      const it = items.find(x => x.id === id);
      if (!it) return;
      selectedId = it.id;

      nameEl.value = it.name || "";
      skuEl.value = it.sku || "";
      payloadEl.value = it.payload || ""; // th∆∞·ªùng tr·ªëng n·∫øu import

      renderQR();
      renderTable();
      setStatus("ƒê√£ n·∫°p item t·ª´ danh s√°ch v√† hi·ªÉn th·ªã QR.", "ok");
    }

    function deleteItemById(id){
      const it = items.find(x=>x.id===id);
      items = items.filter(x=>x.id!==id);
      if (selectedId === id) selectedId = null;
      saveItems();
      renderTable();
      setStatus(`ƒê√£ xo√°: ${it?.name || "item"}.`, "ok");
    }

    function upsertCurrent(){
      const name = normalize(nameEl.value);
      const sku  = normalize(skuEl.value);
      const payload = normalize(payloadEl.value); // optional

      if (!name){ setStatus("Thi·∫øu T√™n (c·∫ßn ƒë·ªÉ t√¨m ki·∫øm/l·ªçc).", "err"); return; }
      if (!sku){ setStatus("Thi·∫øu M√£ s·∫£n ph·∫©m.", "err"); return; }

      // merge by SKU
      const idx = items.findIndex(x => normalize(x.sku) === sku);
      if (idx >= 0){
        items[idx] = {
          ...items[idx],
          name, sku, payload,
          createdAt: items[idx].createdAt || nowISO()
        };
        selectedId = items[idx].id;
        saveItems();
        renderTable();
        setStatus("ƒê√£ c·∫≠p nh·∫≠t item theo M√£ s·∫£n ph·∫©m.", "ok");
      }else{
        const it = { id: genId(), name, sku, payload, createdAt: nowISO() };
        items.push(it);
        selectedId = it.id;
        saveItems();
        renderTable();
        setStatus("ƒê√£ l∆∞u item m·ªõi.", "ok");
      }
    }

    // ===== CSV (ƒê√öNG KI·ªÇU: "M√£ s·∫£n ph·∫©m,T√™n s·∫£n ph·∫©m") =====
    function csvEscape(value){
      const s = String(value ?? "");
      if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function exportCSV(){
      // chu·∫©n b·∫°n d√πng: SKU tr∆∞·ªõc, T√™n sau
      const header = ["M√£ s·∫£n ph·∫©m","T√™n s·∫£n ph·∫©m"];
      const rows = items
        .slice()
        .sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""))
        .map(it => [csvEscape(it.sku), csvEscape(it.name)].join(","));

      const csv = [header.join(","), ...rows].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `ds_ma_sp_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      setStatus("ƒê√£ xu·∫•t CSV (M√£ s·∫£n ph·∫©m,T√™n s·∫£n ph·∫©m).", "ok");
    }

    // CSV parser supports quotes/commas/newlines
    function parseCSV(text){
      const out = [];
      let row = [];
      let cur = "";
      let i = 0;
      let inQuotes = false;

      while (i < text.length){
        const c = text[i];

        if (inQuotes){
          if (c === '"'){
            if (text[i+1] === '"'){
              cur += '"';
              i += 2;
              continue;
            }else{
              inQuotes = false;
              i++;
              continue;
            }
          }else{
            cur += c;
            i++;
            continue;
          }
        }else{
          if (c === '"'){ inQuotes = true; i++; continue; }
          if (c === ","){ row.push(cur); cur=""; i++; continue; }
          if (c === "\r"){ i++; continue; }
          if (c === "\n"){ row.push(cur); out.push(row); row=[]; cur=""; i++; continue; }
          cur += c; i++;
        }
      }
      row.push(cur);
      out.push(row);
      if (out.length && out[out.length-1].length === 1 && out[out.length-1][0] === "") out.pop();
      return out;
    }

    function normalizeHeader(h){
      // l√†m ‚Äúm·ªÅm‚Äù: b·ªè d·∫•u + lowercase + b·ªè kho·∫£ng tr·∫Øng th·ª´a
      const s = normalize(h).toLowerCase();
      return s
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"") // b·ªè d·∫•u ti·∫øng Vi·ªát
        .replace(/\s+/g," ")
        .trim();
    }

    async function importCSVFile(file){
      try{
        const text = await file.text();
        const rows = parseCSV(text);
        if (!rows.length){ setStatus("CSV r·ªóng.", "err"); return; }

        const headerRaw = rows[0] || [];
        const header = headerRaw.map(normalizeHeader);

        // detect header: "ma san pham" & "ten san pham"
        const idxSku = header.indexOf("ma san pham");
        const idxName = header.indexOf("ten san pham");
        const hasHeader = (idxSku >= 0 && idxName >= 0);

        const dataRows = hasHeader ? rows.slice(1) : rows;

        let imported = 0;
        let updated = 0;

        for (const r of dataRows){
          // n·∫øu kh√¥ng c√≥ header: c·ªôt 0=sku, c·ªôt 1=name
          const sku  = normalize(hasHeader ? r[idxSku] : r[0]);
          const name = normalize(hasHeader ? r[idxName] : r[1]);

          if (!sku || !name) continue;

          const idx = items.findIndex(x => normalize(x.sku) === sku);
          if (idx >= 0){
            items[idx] = {
              ...items[idx],
              sku,
              name,
              // gi·ªØ payload n·∫øu ƒë√£ c√≥, n·∫øu ch∆∞a c√≥ th√¨ ƒë·ªÉ tr·ªëng (QR s·∫Ω l·∫•y SKU)
              payload: normalize(items[idx].payload || ""),
            };
            updated++;
          }else{
            items.push({
              id: genId(),
              sku,
              name,
              payload: "",          // import theo chu·∫©n b·∫°n d√πng: ch·ªâ 2 c·ªôt
              createdAt: nowISO()
            });
            imported++;
          }
        }

        saveItems();
        renderTable();
        setStatus(`Nh·∫≠p CSV xong. Th√™m m·ªõi: ${imported}, c·∫≠p nh·∫≠t theo M√£ s·∫£n ph·∫©m: ${updated}.`, "ok");
      }catch(e){
        console.error(e);
        setStatus("L·ªói nh·∫≠p CSV. Ki·ªÉm tra ƒë·ªãnh d·∫°ng file (2 c·ªôt: M√£ s·∫£n ph·∫©m,T√™n s·∫£n ph·∫©m).", "err");
      }finally{
        csvFileEl.value = "";
      }
    }

    function clearForm(){
      selectedId = null;
      nameEl.value = "";
      skuEl.value = "";
      payloadEl.value = "";
      updateLen();
      clearQRBox();
      renderTable();
      setStatus("ƒê√£ xo√° form.", "ok");
    }

    function clearAllList(){
      if (!items.length){ setStatus("Danh s√°ch ƒëang tr·ªëng.", "err"); return; }
      items = [];
      selectedId = null;
      saveItems();
      renderTable();
      clearQRBox();
      setStatus("ƒê√£ xo√° to√†n b·ªô danh s√°ch.", "ok");
    }

    async function copyAllSkus(){
      const arr = filteredItems().map(it => normalize(it.sku)).filter(Boolean);
      if (!arr.length){ setStatus("Kh√¥ng c√≥ M√£ s·∫£n ph·∫©m ƒë·ªÉ copy.", "err"); return; }
      const ok = await copyToClipboard(arr.join("\n"));
      setStatus(ok ? "ƒê√£ copy danh s√°ch M√£ s·∫£n ph·∫©m (m·ªói d√≤ng 1 m√£)." : "Copy th·∫•t b·∫°i.", ok ? "ok" : "err");
    }

    // ===== Events =====
    pasteBtn.addEventListener("click", pasteFromClipboard);
    makeBtn.addEventListener("click", renderQR);
    saveBtn.addEventListener("click", () => { upsertCurrent(); renderQR(); });
    downloadBtn.addEventListener("click", downloadPNG);
    clearBtn.addEventListener("click", clearForm);

    payloadEl.addEventListener("input", () => { updateLen(); renderQR(); });
    skuEl.addEventListener("input", () => { updateLen(); renderQR(); });
    searchEl.addEventListener("input", renderTable);

    tbody.addEventListener("click", async (e) => {
      const btn = e.target.closest("[data-action]");
      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;
      const id = tr.getAttribute("data-id");

      const action = btn?.getAttribute("data-action") || (e.target.matches("td.clickable") ? "show" : null);
      if (!action) return;

      if (action === "show"){
        selectItemById(id);
        return;
      }
      if (action === "copySku"){
        const it = items.find(x=>x.id===id);
        const ok = await copyToClipboard(it?.sku || "");
        setStatus(ok ? "ƒê√£ copy M√£ s·∫£n ph·∫©m." : "Copy th·∫•t b·∫°i.", ok ? "ok" : "err");
        return;
      }
      if (action === "del"){
        deleteItemById(id);
        return;
      }
    });

    csvFileEl.addEventListener("change", () => {
      const file = csvFileEl.files?.[0];
      if (file) importCSVFile(file);
    });

    exportBtn.addEventListener("click", exportCSV);
    clearListBtn.addEventListener("click", clearAllList);
    copyAllSkusBtn.addEventListener("click", copyAllSkus);

    // ===== Init =====
    (function init(){
      const ok = !!navigator.clipboard?.readText;
      envEl.textContent = "Clipboard: " + (ok ? "h·ªó tr·ª£ readText" : "kh√¥ng h·ªó tr·ª£ readText");
      countEl.textContent = String(items.length);
      updateLen();
      renderTable();
      clearQRBox();
      setStatus("S·∫µn s√†ng.", "ok");
    })();
  </script>
</body>
</html>
